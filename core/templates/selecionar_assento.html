{% load static %}
<!doctype html>
<link rel="icon" type="image/png" href="{% static 'core/img/favicon.png' %}">
<link rel="shortcut icon" href="{% static 'core/img/favicon.png' %}">
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Selecionar Assento — Fly Track</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --ink:#0b1e45; --muted:#506079;
      --line:#dfe5f2; --accent:#ff5a00; --accent-ink:#fff; --green:#16a34a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,sans-serif;color:var(--ink);}
    header{padding:20px 28px;display:flex;justify-content:space-between;align-items:center;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.05);}
    header h1{font-size:20px;margin:0;}
    header a{color:var(--accent);text-decoration:none;font-weight:600;}

    main{max-width:1100px;margin:24px auto;padding:0 18px;display:grid;gap:20px;grid-template-columns:1.1fr 0.9fr;}
    @media (max-width:900px){ main{grid-template-columns:1fr;} }

    .panel{background:var(--card);border-radius:20px;padding:24px;border:1px solid var(--line);box-shadow:0 16px 30px rgba(10,35,60,.08);}
    .summary h2{margin:0 0 8px;font-size:24px;}
    .summary p{margin:0;color:var(--muted);}  
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:#eef2ff;color:#2b4d9f;font-weight:600;font-size:13px;}

    .seats{display:flex;flex-direction:column;gap:12px;margin-top:24px;padding:20px;background:#f9fbff;border-radius:16px;border:2px dashed #dfe5f2;}
    .plane-header{text-align:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--line);}
    .plane-header h3{margin:0 0 8px;font-size:18px;color:var(--ink);}
    .plane-header p{margin:0;font-size:13px;color:var(--muted);}
    .seat-row{display:grid;grid-template-columns:auto repeat(3,1fr) 40px repeat(3,1fr);gap:8px;align-items:center;padding:8px 12px;background:#fff;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.03);}
    .seat-row-label{font-weight:700;color:var(--muted);font-size:14px;min-width:40px;text-align:center;}
    .aisle{grid-column:5;display:flex;align-items:center;justify-content:center;color:#c7d1e0;font-size:11px;font-weight:600;letter-spacing:.1em;}
    .seat{position:relative;border:2px solid var(--line);border-radius:8px;padding:12px 8px;text-align:center;font-weight:700;background:#fff;cursor:pointer;transition:.15s;display:flex;flex-direction:column;gap:2px;align-items:center;min-height:50px;justify-content:center;}
    .seat:hover:not([data-status="ocupado"]){transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.1);}
    .seat[data-status="ocupado"]{background:#f3f4f6;color:#a3a3a3;border-color:#e5e7eb;border-style:dashed;cursor:not-allowed;}
    .seat[data-status="ocupado"]::after{content:"✕";font-size:14px;position:absolute;right:6px;top:6px;color:#d34747;}
    .seat[data-status="premium"]{background:#fff9f0;border-color:#f7c27d;box-shadow:0 0 0 2px #fff5e5;}
    .seat.is-selected{border-color:#2f80ed;background:#eef5ff;box-shadow:0 0 0 3px rgba(47,128,237,.2);transform:scale(1.05);}
    .seat-label{font-size:14px;font-weight:800;}
    .seat-tag{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:#8290a3;}
    .seat[data-status="premium"] .seat-tag{color:#c26a00;}
    .seat[data-status="ocupado"] .seat-tag{color:#a3a3a3;}
    .legend{display:flex;gap:20px;justify-content:center;margin-top:20px;flex-wrap:wrap;}
    .legend-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);}
    .legend-box{width:20px;height:20px;border-radius:4px;border:2px solid var(--line);}
    .seat-helper{margin:0;color:var(--muted);}
    .seat-helper.is-error{color:#c0392b;}
    .pax-stepper{display:flex;align-items:center;justify-content:space-between;background:#f7f9ff;border:1px solid var(--line);border-radius:12px;padding:10px 14px;margin:8px 0 0;gap:16px;}
    .pax-stepper .stepper{display:flex;align-items:center;gap:10px;}
    .pax-stepper button{width:32px;height:32px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700;font-size:18px;line-height:1;}
    .pax-stepper span{font-weight:800;min-width:28px;text-align:center;font-size:16px;}

    .aside-card{display:flex;flex-direction:column;gap:14px;}
    .price{font-size:28px;font-weight:900;}
    .cta{border:0;border-radius:14px;background:var(--accent);color:var(--accent-ink);padding:14px 18px;font-size:16px;font-weight:700;cursor:pointer;}
    .cta:disabled{opacity:.5;cursor:not-allowed;}
  </style>
</head>
<body>
  <header>
    <h1>Selecionar Assento</h1>
    <a href="{% url 'core:resultados' %}" class="voltar-link">&lt; Voltar</a>
  </header>

  <main>
    <section class="panel summary">
      <h2>{{ origem }} → {{ destino }}</h2>
      <p>{{ data_viagem|default:"Data a confirmar" }} · Voo {{ codigo }} · Segmento {{ segmento|title }}</p>
      <div class="badge">Tarifa {{ tarifa|default:"R$ -" }}</div>

      <div class="seats">
        <div class="plane-header">
          <h3>✈️ Layout da Aeronave</h3>
          <p>A • B • C &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp; Corredor &nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; D • E • F</p>
        </div>
        <div id="seatGrid">
          {% for row in seat_rows %}
            <div class="seat-row">
              <div class="seat-row-label">{{ row.row }}</div>
              {% for seat in row.seats %}
                {% if forloop.counter == 4 %}
                  <div class="aisle">━━</div>
                {% endif %}
                <button class="seat" type="button" data-seat="{{ seat.label }}" data-status="{{ seat.status }}">
                  <span class="seat-label">{{ seat.label }}</span>
                  {% if seat.status == 'premium' %}
                    <span class="seat-tag">⭐</span>
                  {% elif seat.status == 'ocupado' %}
                    <span class="seat-tag">•</span>
                  {% endif %}
                </button>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-box" style="background:#fff;border-color:#dfe5f2;"></div>
            <span>Disponível</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background:#fff9f0;border-color:#f7c27d;"></div>
            <span>Premium</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background:#f3f4f6;border-color:#e5e7eb;border-style:dashed;"></div>
            <span>Ocupado</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background:#eef5ff;border-color:#2f80ed;"></div>
            <span>Selecionado</span>
          </div>
        </div>
      </div>
    </section>

    <aside class="panel aside-card">
      <div>
        <div class="muted">Tarifa base</div>
        <div class="price" id="precoTarifa">{{ tarifa|default:"R$ -" }}</div>
      </div>
      <div>
        <div class="muted">Assentos selecionados</div>
        <div id="seatChoice">Nenhum</div>
      </div>
      {% with pax_lim=pax_total|default:1 %}
        <p class="seat-helper" id="seatHelper">Selecione até {{ pax_lim }} assento{% if pax_lim|add:'-1' %}s{% endif %}.</p>
        <div class="pax-stepper" aria-live="polite">
          <div>
            <div class="muted">Passageiros neste voo</div>
            <small id="paxLimitHint">Limite atual: {{ pax_lim }}</small>
          </div>
          <div class="stepper" role="group" aria-label="Ajustar quantidade de passageiros">
            <button type="button" id="paxMinus" aria-label="Diminuir">−</button>
            <span id="paxCount">{{ pax_lim }}</span>
            <button type="button" id="paxPlus" aria-label="Aumentar">+</button>
          </div>
        </div>
      {% endwith %}
      <p class="muted">Assentos premium adicionam R$ 90,00 à tarifa selecionada.</p>
      <button class="cta" id="confirmSeat" disabled
        data-origem="{{ origem }}"
        data-destino="{{ destino }}"
        data-data="{{ data_viagem }}"
        data-tarifa="{{ tarifa }}"
        data-codigo="{{ codigo }}"
        data-segmento="{{ segmento }}"
      >Confirmar Assento</button>
    </aside>
  </main>

  <script>
    const seatGrid = document.getElementById('seatGrid');
    const seatChoice = document.getElementById('seatChoice');
    const confirmSeat = document.getElementById('confirmSeat');
    const seatHelper = document.getElementById('seatHelper');
    const paxLimitHint = document.getElementById('paxLimitHint');
    const paxMinus = document.getElementById('paxMinus');
    const paxPlus = document.getElementById('paxPlus');
    const paxCountEl = document.getElementById('paxCount');
    const baseFareEl = document.getElementById('precoTarifa');
    let paxLimit = Math.max(1, Number('{{ pax_total }}') || 1);
    const selectedSeats = new Map();
    const MAX_PAX = 9;
    const PREMIUM_SURCHARGE = 90;

    // Normalizes fares regardless of thousand/decimal separators (pt-BR vs en-US).
    function sanitizeCurrency(text){
      if (!text) return 0;
      const cleaned = text.replace(/[^0-9,.-]/g, '');
      if (!cleaned) return 0;
      const usesComma = cleaned.includes(',');
      const usesDot = cleaned.includes('.');

      if (usesComma){
        const collapsed = cleaned.replace(/\./g, '');
        const normalized = collapsed.replace(/,(\d{2})$/, '.$1');
        const num = Number(normalized);
        return Number.isFinite(num) ? num : 0;
      }

      if (usesDot && /\.\d{2}$/.test(cleaned)){
        const num = Number(cleaned);
        return Number.isFinite(num) ? num : 0;
      }

      const num = Number(cleaned.replace(/\./g, ''));
      return Number.isFinite(num) ? num : 0;
    }

    function formatBRL(value){
      if (!Number.isFinite(value) || value <= 0) return 'R$ -';
      return value.toLocaleString('pt-BR', { style:'currency', currency:'BRL', minimumFractionDigits:2 });
    }

    const baseFareValue = sanitizeCurrency(baseFareEl?.textContent || '');

    function updateSeatSummary(){
      const seats = Array.from(selectedSeats.keys());
      seatChoice.textContent = seats.length ? seats.join(', ') : 'Nenhum';
      confirmSeat.disabled = seats.length === 0;
      confirmSeat.textContent = seats.length > 1 ? `Confirmar ${seats.length} assentos` : 'Confirmar Assento';
      const remaining = paxLimit - seats.length;
      const premiumCount = seats.filter(seat => selectedSeats.get(seat) === 'premium').length;
      const premiumExtra = premiumCount * PREMIUM_SURCHARGE;
      const helperBase = remaining > 0
        ? `Selecionados ${seats.length} de ${paxLimit} assento${paxLimit>1?'s':''}.`
        : `Limite atingido: ${paxLimit} assento${paxLimit>1?'s':''}.`;
      const helperSuffix = premiumCount ? ` · Premium: ${premiumCount} × R$ ${PREMIUM_SURCHARGE.toFixed(0)}` : '';
      seatHelper.textContent = helperBase + helperSuffix;
      seatHelper.classList.remove('is-error');
      paxLimitHint.textContent = `Limite atual: ${paxLimit}`;
      if (paxCountEl) paxCountEl.textContent = paxLimit;
      const seatCount = Math.max(seats.length, 1);
      const basePortion = baseFareValue * seatCount;
      const totalWithPremium = basePortion + premiumExtra;
      if (baseFareEl){
        baseFareEl.textContent = formatBRL(basePortion);
      }
      if (confirmSeat){
        confirmSeat.dataset.premiumCount = String(premiumCount);
        confirmSeat.dataset.premiumExtra = String(premiumExtra);
        confirmSeat.dataset.tarifa = formatBRL(basePortion);
        confirmSeat.dataset.total = formatBRL(totalWithPremium);
        confirmSeat.dataset.seatCount = String(seatCount);
      }
    }

    let helperTimeout;
    function showHelperError(message){
      seatHelper.textContent = message;
      seatHelper.classList.add('is-error');
      clearTimeout(helperTimeout);
      helperTimeout = setTimeout(updateSeatSummary, 2800);
    }

    if (seatGrid){
      seatGrid.addEventListener('click', (event)=>{
        const btn = event.target.closest('.seat');
        if (!btn || btn.dataset.status === 'ocupado') return;
        const seatId = btn.dataset.seat;
        const status = btn.dataset.status || 'livre';

        if (btn.classList.contains('is-selected')){
          btn.classList.remove('is-selected');
          selectedSeats.delete(seatId);
          updateSeatSummary();
          return;
        }

        if (selectedSeats.size >= paxLimit){
          showHelperError(`Você já selecionou ${paxLimit} assento${paxLimit>1?'s':''}. Remova um para continuar.`);
          return;
        }

        btn.classList.add('is-selected');
        selectedSeats.set(seatId, status);
        updateSeatSummary();
      });
    }

    function persistPaxInUrl(){
      const params = new URLSearchParams(location.search);
      if (paxLimit > 1) params.set('pax', paxLimit);
      else params.delete('pax');
      const qs = params.toString();
      const newUrl = qs ? `${location.pathname}?${qs}` : location.pathname;
      history.replaceState(null, '', newUrl);
    }

    function adjustPax(delta){
      const desired = Math.max(1, Math.min(MAX_PAX, paxLimit + delta));
      if (desired === paxLimit) return;
      if (desired < selectedSeats.size){
        showHelperError(`Você já selecionou ${selectedSeats.size} assento${selectedSeats.size>1?'s':''}. Remova um antes de reduzir.`);
        return;
      }
      paxLimit = desired;
      updateSeatSummary();
      persistPaxInUrl();
    }

    paxMinus?.addEventListener('click', ()=> adjustPax(-1));
    paxPlus?.addEventListener('click', ()=> adjustPax(1));

    confirmSeat?.addEventListener('click', ()=>{
      const seatCount = selectedSeats.size;
      if (!seatCount) return;
      const seats = Array.from(selectedSeats.keys());
      const premiumCount = Number(confirmSeat.dataset.premiumCount || '0');
      const tarifaParam = confirmSeat.dataset.tarifa || formatBRL(baseFareValue * Math.max(seatCount, 1));
      const params = new URLSearchParams({
        origem: confirmSeat.dataset.origem || '',
        destino: confirmSeat.dataset.destino || '',
        data: confirmSeat.dataset.data || '',
        tarifa: tarifaParam,
        codigo: confirmSeat.dataset.codigo || '',
        segmento: confirmSeat.dataset.segmento || 'ida',
        pax: String(Math.max(seatCount, 1)),
        assentos: seats.join(','),
      });
      if (premiumCount > 0) params.set('premium_count', String(premiumCount));
      if (confirmSeat.dataset.total) params.set('total', confirmSeat.dataset.total);
      window.location.href = `/resultados/resumo/?${params.toString()}`;
    });

    updateSeatSummary();
  </script>
</body>
</html>
