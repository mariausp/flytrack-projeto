{% load static %}
<link rel="icon" type="image/png" href="{% static 'core/img/favicon.png' %}">
<link rel="shortcut icon" href="{% static 'core/img/favicon.png' %}">

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fly Track — Encontre e Reserve Passagens Acessíveis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#edf6fb;
      --bg2:#cfe6fb;
      --card:#ffffff;
      --ink:#0b1e45;
      --muted:#3a5674;
      --line:#e5eef6;
      --cta:#ff5a00;
      --cta-ink:#ffffff;
      --pill:#f6fafc;
      --accent:#2f80ed;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif; color:var(--ink); background:var(--bg); }
    .wrap{max-width:1200px;margin:32px auto;padding:0 20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:28px;padding:28px;box-shadow:0 12px 30px rgba(13,35,60,.06)}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
    .brand{font-weight:800;letter-spacing:.2px;}
    .nav ul{display:flex;gap:28px;list-style:none;margin:0;padding:0;align-items:center}
    .nav a{color:var(--ink);text-decoration:none;font-weight:600}
    .login{background:#ff8a50;color:#fff;font-weight:700;padding:10px 20px;border-radius:999px;text-decoration:none;border:2px solid #ffd8c3}

    /* menu do usuário */
    .user-menu{display:flex;align-items:center;gap:12px}
    .user-chip{background:var(--pill);border:1px solid var(--line);padding:8px 12px;border-radius:999px;font-weight:700}
    .logout-btn{background:#fff;border:1.5px solid var(--line);padding:8px 14px;border-radius:10px;text-decoration:none;color:var(--muted);font-weight:700}
    .logout-btn:hover{border-color:var(--accent);color:var(--accent);background:#f7fbff}

    .hero{display:grid;grid-template-columns:1.05fr .95fr;gap:30px;align-items:center}
    .title{font-size:clamp(28px,5vw,54px);line-height:1.1;margin:6px 0 12px 0}
    .lead{color:var(--muted);margin:0 0 22px 0;font-size:18px}

    .search{background:#f7fbff;border:2px solid var(--line);border-radius:22px;padding:14px;display:flex;gap:12px;align-items:center;box-shadow:inset 0 2px 0 rgba(255,255,255,.6)}
    .field{flex:1;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px 14px;display:flex;align-items:center;gap:10px; position:relative;}
    .field input{border:0;outline:0;width:100%;font-size:16px;color:var(--ink);background:transparent;min-width:0}
    .field input::placeholder{color:#8aa2bb}
    .icon{width:22px;height:22px;display:inline-block;flex-shrink:0;color:var(--accent)}
    .arrow{display:flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:12px;background:var(--pill);border:1px dashed var(--line);flex:0 0 48px}
    .btn{background:var(--cta);color:var(--cta-ink);font-weight:700;border:0;border-radius:18px;padding:14px 26px;cursor:pointer;font-size:18px;box-shadow:0 6px 14px rgba(255,90,0,.25)}
    .btn:focus-visible{outline:3px solid #ffd2ba;outline-offset:2px}
    .benefits{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin-top:26px}
    .benefit{display:flex;gap:12px;align-items:center;color:var(--ink);background:var(--pill);border:1px solid var(--line);padding:14px 16px;border-radius:16px}
    .benefit span{font-weight:700}
    .plane{width:150%;height:auto}
    .note{color:#678;font-size:13px;margin-top:14px}
    @media (max-width:980px){.hero{grid-template-columns:1fr}.nav ul{gap:16px}}
    @media (max-width:640px){.search{flex-direction:column;align-items:stretch}.arrow{display:none}.btn{width:100%}}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* ===== Autocomplete & larguras ===== */
    .field-origin,.field-dest{flex:1 1 320px;min-width:220px}
    .field.suggest{position:relative}
    .suggest-list{
      position:absolute; top:calc(100% + 6px); left:0; width:100%;
      box-sizing:border-box; max-height:280px; overflow-y:auto; padding:6px;
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      box-shadow:0 14px 28px rgba(10,35,60,.12); z-index:50; display:none;
    }

    .suggest-list button{
      width:100%; padding:12px 14px; font-size:15.5px; line-height:1.2;
      border:0; background:transparent; border-radius:10px; text-align:left; cursor:pointer;
      white-space:nowrap;
    }
    .suggest-list button:hover,.suggest-list button:focus{background:#f1f6fb; outline:none}

    .lead + .search { margin-top: 40px; }

    /* Ajustes do avião */
    .hero > div:last-child .plane {
      width: 300%;
      height: auto;
      transform: translate(-360px, -100px) rotate(-3deg);
      transform-origin: center right;
    }
    .card{ position: relative; z-index: 2; }
    .hero > div:last-child{ position: relative; z-index: 0; }
    .plane{ position: relative; z-index: 0; pointer-events: none; }

    .suggest-list{ z-index: 9999; }
    .field{ overflow: visible; }

    .title { margin-top: 80px; }
    .lead { margin-top: 10px; }

    .brand{ font-size: 25px; font-weight: 800; letter-spacing: .2px; }
    @media (min-width: 1200px){ .brand{ font-size: 25px; } }

    /* ====== DATA ====== */
    .field input[type="date"]::-webkit-calendar-picker-indicator{ display:none; }
    .field input[type="date"]::-webkit-inner-spin-button{ display:none; }
    .field input[type="date"]::-webkit-clear-button{ display:none; }
    .field input[type="date"]{ -moz-appearance: textfield; appearance: none; cursor: pointer; }

    .field-date{ padding-right:44px; cursor:pointer; }
    .field-date input{ cursor:pointer; }
    .date-btn{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      width:32px; height:32px; border:1px solid var(--line); border-radius:8px;
      background:#fff; display:flex; align-items:center; justify-content:center;
      cursor:pointer; box-shadow:0 2px 6px rgba(10,35,60,.06);
    }
    .date-btn:hover{ background:#f7fbff; }
    .field.error{ border-color:#e53935 !important; box-shadow:0 0 0 3px rgba(229,57,53,.08); }
    .error{ color:#c62828; font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- NAV -->
      <nav class="nav" aria-label="primária">
        <div class="brand">Fly Track</div>
        <ul>
          <li><a href="{% url 'core:home' %}">Início</a></li>
          <li><a href="{% url 'core:historico' %}">Histórico de Viagens</a></li>
          <li><a href="{% url 'core:contato' %}">Contato</a></li>
          {# Botão do painel (apenas para superusuários) #}
          {% if user.is_authenticated and user.is_superuser %}
            <li><a href="{% url 'core:admin_home' %}" style="background:#222;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700;">Painel</a></li>
          {% endif %}
          {% if user.is_authenticated %}
            <li class="user-menu">
              <span class="user-chip">Olá, {{ user.get_full_name|default:user.username }}!</span>
              <form action="{% url 'logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="logout-btn">Sair</button>
              </form>
            </li>
          {% else %}
            {% if user.is_authenticated %}
              <li>Olá, {{ user.username }}!</li>
              <li>
                <form action="{% url 'logout' %}" method="post" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="login" style="background:#ccc; color:#0b1e45;">Sair</button>
                </form>
              </li>
            {% else %}
              <li><a class="login" href="{% url 'login' %}">Log in</a></li>
            {% endif %}
          {% endif %}
        </ul>
      </nav>

      <!-- HERO -->
      <section class="hero">
        <div>
          <h1 class="title">Encontre e Reserve<br/>Passagens Acessíveis</h1>
          <p class="lead">Planeje sua próxima viagem com facilidade e confiança.</p>

          <!-- SEARCH BAR -->
          <form class="search" id="searchForm" action="{% url 'core:resultados' %}" method="GET" autocomplete="off">
            <label class="sr-only" for="origem">Origem</label>
            <div class="field suggest field-origin">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 21s-6-5.33-6-10a6 6 0 1 1 12 0c0 4.67-6 10-6 10z"/><circle cx="12" cy="11" r="2.5"/>
              </svg>
              <input id="origem" name="origem" placeholder="Saída" required />
              <div class="suggest-list" id="suggestOrigem" role="listbox" aria-label="Sugestões de origem"></div>
            </div>

            <div class="arrow" aria-hidden="true">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14m0 0-4-4m4 4-4 4"/>
              </svg>
            </div>

            <label class="sr-only" for="destino">Destino</label>
            <div class="field suggest field-dest">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 7l16 5-16 5 5-5-5-5z"/>
              </svg>
              <input id="destino" name="destino" placeholder="Destino" required/>
              <div class="suggest-list" id="suggestDestino" role="listbox" aria-label="Sugestões de destino"></div>
            </div>

            <label class="sr-only" for="data">Data</label>
            <div class="field field-date">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="3"/><path d="M16 2v4M8 2v4M3 10h18"/>
              </svg>
              <input id="data" name="data" type="date" required />
              <button type="button" class="date-btn" aria-label="Abrir calendário">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <rect x="3" y="4" width="18" height="18" rx="3"/>
                  <path d="M16 2v4M8 2v4M3 10h18"/>
                </svg>
              </button>
              <span id="dateError" class="error" aria-live="polite"></span>
            </div>

            <button class="btn" type="submit">Buscar</button>
          </form>

          <div class="benefits">
            <div class="benefit">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1v22M5 6h14a3 3 0 0 1 0 6H5a3 3 0 0 1 0-6zM5 13h14a3 3 0 0 1 0 6H5a3 3 0 0 1 0-6z"/>
              </svg>
              <div><span>Menores preços</span><br/>Garantidos</div>
            </div>
            <div class="benefit">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="16" rx="3"/><path d="M7 8h10M7 12h6M7 16h8"/>
              </svg>
              <div><span>Agendamento</span><br/>Fácil e Rápido</div>
            </div>
            <div class="benefit">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a7 7 0 0 1 7 7v3h1a3 3 0 0 1 3 3v6a3 3 0 0 1-3 3H4a3 3 0 0 1-3-3v-6a3 3 0 0 1 3-3h1V8a7 7 0 0 1 7-7z"/>
              </svg>
              <div><span>Pagamento</span><br/>Seguro</div>
            </div>
          </div>
        </div>

        <!-- Plane Illustration -->
        <div>
          <img class="plane" src="{% static 'core/img/aviao.png' %}" alt="Ilustração de avião" loading="lazy" />
        </div>
      </section>
    </div>
  </div>

  <!-- AUTOCOMPLETE + REDIRECT -->
  <script>
    const brazilCities = [
      "São Paulo, SP","Rio de Janeiro, RJ","Belo Horizonte, MG","Brasília, DF","Salvador, BA",
      "Fortaleza, CE","Recife, PE","Porto Alegre, RS","Curitiba, PR","Manaus, AM",
      "Belém, PA","Goiânia, GO","Campinas, SP","São Luís, MA","Maceió, AL",
      "Natal, RN","Teresina, PI","João Pessoa, PB","Aracaju, SE","Cuiabá, MT",
      "Campo Grande, MS","Florianópolis, SC","Vitória, ES","Macapá, AP","Palmas, TO",
      "Ribeirão Preto, SP","Santos, SP","Sorocaba, SP","São José dos Campos, SP",
      "Jundiaí, SP","Piracicaba, SP","Santo André, SP","São Bernardo do Campo, SP",
      "Osasco, SP","Guarulhos, SP","Niterói, RJ","Duque de Caxias, RJ",
      "Uberlândia, MG","Juiz de Fora, MG","Londrina, PR","Maringá, PR",
      "Joinville, SC","Blumenau, SC","Caxias do Sul, RS","Pelotas, RS"
    ];
    const extras = ["Nova Iorque, EUA","Nova Orleans, EUA","Nova Deli, Índia","Newark (EWR), EUA"];
    const destinos = [...brazilCities, ...extras];

    const normalize = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

    function createAutocomplete(inputId, listId, dataset){
      const input = document.getElementById(inputId);
      const list  = document.getElementById(listId);
      if(!input || !list) return;

      function render(items){
        list.innerHTML='';
        if(items.length===0){ list.style.display='none'; return; }
        items.forEach(text=>{
          const btn=document.createElement('button');
          btn.type='button'; btn.role='option'; btn.textContent=text;
          btn.addEventListener('mousedown', (e)=>{
            e.preventDefault();
            input.value=text;
            list.style.display='none';
            input.dispatchEvent(new Event('input', {bubbles:true}));
          });
          list.appendChild(btn);
        });
        list.style.display='block';
      }

      let to, idx=-1;
      function search(){
        const q=normalize(input.value.trim());
        if(!q){ list.style.display='none'; return; }
        render(dataset.filter(d=>normalize(d).includes(q)).slice(0,7));
      }
      input.addEventListener('input', ()=>{ clearTimeout(to); to=setTimeout(search,120); });

      input.addEventListener('keydown', (e)=>{
        const options=Array.from(list.querySelectorAll('button'));
        if(list.style.display!=='block'||options.length===0) return;
        if(e.key==='ArrowDown'){ e.preventDefault(); idx=(idx+1)%options.length; options[idx].focus(); }
        if(e.key==='ArrowUp'){ e.preventDefault(); idx=(idx-1+options.length)%options.length; options[idx].focus(); }
        if(e.key==='Enter' && document.activeElement.parentElement===list){ e.preventDefault(); document.activeElement.click(); }
        if(e.key==='Escape'){ list.style.display='none'; }
      });

      document.addEventListener('click', (e)=>{
        if(!list.contains(e.target) && e.target!==input){ list.style.display='none'; }
      });
    }

    createAutocomplete('origem','suggestOrigem',brazilCities);
    createAutocomplete('destino','suggestDestino',destinos);

    // === DATA: min = hoje, botão abre calendário e validação ===
    const dateInput = document.getElementById('data');
    const dateField = document.querySelector('.field-date');
    const dateBtn   = document.querySelector('.date-btn');
    const dateError = document.getElementById('dateError');

    function todayISO(){
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    const today = todayISO();
    if (dateInput) dateInput.min = today;

    function openPicker(){
      if (typeof dateInput.showPicker === 'function'){ dateInput.showPicker(); return; }
      dateInput.focus();
      try { dateInput.click(); } catch(_) {}
      const ev = new KeyboardEvent('keydown', { key:'ArrowDown', altKey:true, bubbles:true, cancelable:true });
      dateInput.dispatchEvent(ev);
    }
    if (dateBtn) dateBtn.addEventListener('click', openPicker);

    if (dateField){
      dateField.addEventListener('click', (e) => {
        if (e.target === dateInput) return;
        if (e.target.closest && e.target.closest('.date-btn')) return;
        openPicker();
      });
      if (!dateField.hasAttribute('tabindex')) dateField.tabIndex = 0;
      dateField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openPicker();
        }
      });
    }

    function isDateValid(){
      const v = dateInput.value;
      return v && v >= (dateInput.min || today);
    }
    function showDateError(msg){
      dateField.classList.add('error');
      dateError.textContent = msg;
    }
    function clearDateError(){
      dateField.classList.remove('error');
      dateError.textContent = '';
    }
    dateInput.addEventListener('change', ()=>{
      if (isDateValid()) clearDateError();
      else showDateError('Escolha uma data a partir de hoje.');
    });

    document.getElementById('searchForm').addEventListener('submit',(e)=>{
      if (!isDateValid()){
        e.preventDefault();
        showDateError('Escolha uma data a partir de hoje.');
        dateInput.focus();
        return;
      }
      const o=encodeURIComponent(document.getElementById('origem').value||'São Paulo, SP - BR');
      const d=encodeURIComponent(document.getElementById('destino').value||'New York, NY - USA');
      const dt=encodeURIComponent(dateInput.value||'');
    });
  </script>
</body>
</html>
