{% load static %}

<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Resultados ‚Äî Fly Track</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="{% static 'core/img/favicon.png' %}">
<link rel="shortcut icon" href="{% static 'core/img/favicon.png' %}">
<style>
  :root{
    --bg:#eaf2f7; --card:#fff; --ink:#0b1e45; --muted:#3a5674; --line:#dfeaf3;
    --primary:#1677c6; --primary-ink:#fff; --accent:#ff5a00; --accent-ink:#fff;
    --chip:#eef6ff; --ok:#2ecc71;
  }
  *{box-sizing:border-box}

  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1260px;margin:28px auto;padding:0 18px}

  /* layout */
  .grid{display:grid;grid-template-columns:340px 1fr;gap:22px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

  /* painel lateral */
  .panel{
    background:#0c6aa9; color:#eaf6ff; border-radius:22px; padding:22px;
    border:1px solid rgba(255,255,255,.25);
    box-shadow:0 16px 40px rgba(12,106,169,.18);
  }
  .panel h2{margin:0 0 16px 0; font-size:26px}
  .seg{display:flex;gap:10px;margin:12px 0 18px}
  .seg button{
    border:1px solid rgba(255,255,255,.35); background:transparent; color:#eaf6ff;
    padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700;
  }
  .seg button.is-active{background:#0aa1ff;border-color:#70d3ff}
  .field{
    background:#e8f4ff; color:#0a2d4e; border:2px solid #cfe6fb; border-radius:14px;
    padding:12px 14px; margin:10px 0; font-weight:700; box-shadow: inset 0 2px 0 rgba(255,255,255,.6);
  }
  .field small{display:block;color:#0a2d4e;font-weight:600;opacity:.85;margin-bottom:6px}
  .swap{float:right; background:#0aa1ff; color:#003253; border-radius:999px; border:0; width:36px; height:36px;
        display:inline-flex; align-items:center; justify-content:center; cursor:pointer; margin-left:6px}
  .toggle{
    display:flex; align-items:center; gap:10px; color:#eaf6ff; margin:16px 0 6px;
  }
  .switch{
    width:46px;height:26px;background:#f6a57f;border-radius:999px;border:2px solid #ffd7c5;position:relative;cursor:pointer;
  }
  .switch::after{
    content:""; position:absolute; left:4px; top:50%; transform:translateY(-50%);
    width:18px; height:18px; border-radius:50%; background:#fff; transition:.2s;
  }
  .switch.is-on{background:#ff5a00}
  .switch.is-on::after{left:22px}

  .panel .btn{
    width:100%; margin-top:14px; display:flex; align-items:center; justify-content:center;
    gap:10px; background:var(--accent); color:var(--accent-ink); border:0; border-radius:18px;
    padding:16px 20px; font-size:20px; font-weight:800; cursor:pointer;
    box-shadow:0 12px 26px rgba(255,90,0,.25);
  }

  /* === Caixinhas de data viram bot√µes clic√°veis === */
  /* Pill date: controls for IDA / VOLTA selection.
     Change the CSS variable --pill-min-height to adjust vertical size quickly. */
  :root{ --pill-min-height: 120px; --pill-padding: 12px 12px 14px; --pill-head-font-size:12px; --pill-value-font-size:16px; --card-price-gap:20px; }
  .pill-date{
    position:relative;
    background:#e8f4ff; color:#0a2d4e; border:2px solid #cfe6fb; border-radius:14px;
    padding:var(--pill-padding); font-weight:700; box-shadow: inset 0 2px 0 rgba(255,255,255,.6);
    min-height:var(--pill-min-height); cursor:pointer; user-select:none;
    display:flex; flex-direction:column; justify-content:center;
  }
  .pill-date small{display:block;color:#0a2d4e;font-weight:600;opacity:.85;margin-bottom:6px}
  .pill-date strong{display:block;font-weight:800}
  .pill-date:focus-visible{ outline:3px solid #bfe0ff; outline-offset:2px; }
  .pill-head{ font-weight:700; opacity:.85; margin-bottom:6px; font-size:var(--pill-head-font-size); }
  .pill-value{ font-weight:800; font-size:var(--pill-value-font-size); }

  /* input date invis√≠vel sobre a p√≠lula */
  .pill-date__input{
    position:absolute; inset:0; width:100%; height:100%;
    opacity:0; pointer-events:none;
  }

  /* p√≠lula desabilitada (modo S√≥ ida) */
  .pill-date.is-disabled{
    opacity:.55; filter:saturate(.6); cursor:not-allowed;
  }

  /* topo resultados */
  .top{
    background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px;
  }

  /* cards de voos */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px;
    display:grid; grid-template-columns:100px 1fr 1fr 140px auto; align-items:center; gap:14px; margin-top:14px;
  }
  @media (max-width:1100px){
    .card{grid-template-columns:1fr 1fr; grid-auto-rows:auto}
  }
  .plane-ico{font-size:34px}
  .chunk h3{margin:0 0 2px 0; font-size:26px; letter-spacing:.4px}
  .sub{color:var(--muted); font-weight:600}
  .big{font-size:30px; font-weight:900; text-align:center}
  .btn-seat{
    border:0; background:#106fb6; color:#fff; font-weight:800; padding:9px 12px; border-radius:999px; cursor:pointer;
    margin-top:10px; white-space:nowrap; transition:.2s;
  }
  .btn-seat:hover{background:#0d5a95; transform:translateY(-1px); box-shadow:0 4px 8px rgba(16,111,182,.2);} 
  .price-col{text-align:center; display:flex; flex-direction:column; align-items:center; gap:var(--card-price-gap)}
  .price-col .price{font-size:34px; font-weight:900}
  .buy{border:0; background:#ff8a50; color:#fff; font-weight:900; padding:14px 18px; border-radius:999px; cursor:pointer}

  .bar{height:1px;background:var(--line);margin:12px 0}
  .muted{color:var(--muted)}


    /* === Passsageiros & Classe - popover === */
  .pax-wrap{ position:relative; }
  .pax-pop{
    position:absolute; top:100%; left:0; margin-top:8px; width:320px;
    background:#fff; color:var(--ink);
    border:1px solid var(--line); border-radius:14px; padding:14px;
    box-shadow:0 16px 32px rgba(10,35,60,.18); z-index:60; display:none;
  }
  .pax-pop.is-open{ display:block; }
  .pax-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; }
  .pax-row .lbl{ font-weight:700; }
  function guessIATA(txt){
    txt = (txt||"").toLowerCase();
    // Normalize accents and collapse punctuation
    if (txt.normalize) {
      txt = txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    txt = txt.replace(/[\W_]+/g, ' ').trim();
    // Common typo fixes (ex.: 'S√£op Paulo' -> 'Sao Paulo')
    txt = txt.replace(/\bsaop\b/g, 'sao');
    txt = txt.replace(/\bsaopaulo\b/g, 'sao paulo');

    // Direct IATA detection (if user entered the code)
    const direct = txt.match(/\b([a-zA-Z]{3})\b/);
    if (direct && direct[1]) return direct[1].toUpperCase();

    // No automatic mapping from city name -> IATA any more.
    // Direct IATA detection above will still return a 3-letter code if the user typed it.

    return 'XXX';
  }
  // Return a short city abbreviation (e.g. SP, RJ, NY) for display
  function guessAbbrev(txt){
    txt = (txt||"").toLowerCase();
    if (txt.normalize) {
      txt = txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    txt = txt.replace(/[\W_]+/g, ' ').trim();
    txt = txt.replace(/\bsaop\b/g, 'sao');
    txt = txt.replace(/\bsaopaulo\b/g, 'sao paulo');
    // direct IATA -> abbr (e.g. GRU => SP)
    const direct = txt.match(/\b([a-zA-Z]{3})\b/);
    const iata = (direct && direct[1]) ? direct[1].toUpperCase() : null;
    const iataToAbbr = { 'GRU':'SP','CGH':'SP','GIG':'RJ','EWR':'NYC','JFK':'NYC','BSB':'DF','CNF':'BH','BEL':'BEL','CWB':'CWB','FOR':'FOR','REC':'REC','SSA':'SSA','FLN':'FLN','POA':'POA','MAO':'MAO' };
    if (iata && iataToAbbr[iata]) return iataToAbbr[iata];

 
    const abbrMap = {
      'sao paulo': 'SP', 'guarulhos': 'SP', 'congonhas': 'SP', 'sp': 'SP',
      'rio de janeiro': 'RJ', 'rio': 'RJ', 'galeao': 'RJ', 'rj': 'RJ',
      'belo horizonte': 'BH', 'belem': 'BEL', 'brasilia': 'DF', 'recife': 'REC', 'salvador': 'SSA',
      'fortaleza': 'FOR', 'curitiba': 'CWB', 'florianopolis': 'FLN', 'porto alegre': 'POA', 'manaus': 'MAO',
      'new york': 'NY', 'novaiorque': 'NY', 'londres': 'LON', 'london': 'LON'
    };
    for (const k in abbrMap){
      if (txt.includes(k)) return abbrMap[k];
    }
    // fallback: try to make an abbreviation from city words (first letters)
    const parts = txt.split(/\s+/).filter(Boolean);
    if (parts.length === 1 && parts[0].length <= 3) return parts[0].toUpperCase();
    if (parts.length >= 2){
      const ab = parts.map(p=>p[0]).slice(0,2).join('').toUpperCase();
      return ab;
    }
    return '‚Äî';
 


    <button class="btn" id="refazerBusca">üîé Buscar</button>
  </aside>

  <!-- CONTE√öDO -->
  <main>
    <div class="top">
      <div class="muted" id="titulos">Voos ida e volta</div>
    </div>

    <div id="apiStatus" class="api-status" role="status">Carregando tarifas em tempo real‚Ä¶</div>

    <!-- CARD 1 - IDA -->
    <article class="card">
      <div class="plane-ico">‚úàÔ∏è</div>
      <div class="chunk">
        <h3>IDA</h3>
        <div class="sub" id="idaSub">‚Äî</div>
      </div>
      <div>
        <div class="big" id="origemCode">GRU</div>
        <div class="sub" id="origemCity">{% if default_origem %}{{ default_origem }}{% else %}S√£o Paulo{% endif %}</div>
      </div>
      <div>
        <div class="big" id="destinoCode">EWR</div>
        <div class="sub" id="destinoCity">{% if default_destino %}{{ default_destino }}{% else %}New York{% endif %}</div>
      </div>
      <div class="price-col">
        <div class="price" id="precoRecomendado">R$ -</div>
      </div>
      <div>
        <a class="btn-seat" href="{{ selecionar_assento_url }}?segmento=ida{% if default_origem %}&origem={{ default_origem|urlencode }}{% endif %}{% if default_destino %}&destino={{ default_destino|urlencode }}{% endif %}{% if default_data %}&data={{ default_data|urlencode }}{% endif %}{% if default_pax %}&pax={{ default_pax|urlencode }}{% endif %}" data-segment="ida" data-codigo="FT230">Assento</a>
      </div>
      <div class="bar" style="grid-column:1/-1"></div>
      <div class="muted" style="grid-column:1/-1">1 Adulto ¬∑ Impostos, taxas e encargos</div>
    </article>

    <!-- CARD 2 - VOLTA -->
    <article class="card" id="cardVolta">
      <div class="plane-ico">‚úàÔ∏è</div>
      <div class="chunk">
        <h3>VOLTA</h3>
        <div class="sub" id="voltaSub">‚Äî</div>
      </div>
      <div>
        <div class="big" id="origemCode2">GRU</div>
        <div class="sub" id="origemCity2">{% if default_destino %}{{ default_destino }}{% else %}S√£o Paulo{% endif %}</div>
      </div>
      <div>
        <div class="big" id="destinoCode2">EWR</div>
        <div class="sub" id="destinoCity2">{% if default_origem %}{{ default_origem }}{% else %}New York{% endif %}</div>
      </div>
      <div class="price-col">
        <div class="muted" id="precoMaisBarato">R$ -</div>
      </div>
      <div>
        <a class="btn-seat" href="{{ selecionar_assento_url }}?segmento=volta{% if default_destino %}&origem={{ default_destino|urlencode }}{% endif %}{% if default_origem %}&destino={{ default_origem|urlencode }}{% endif %}{% if default_volta %}&data={{ default_volta|urlencode }}{% endif %}{% if default_pax %}&pax={{ default_pax|urlencode }}{% endif %}" data-segment="volta" data-codigo="FT231">Assento</a>
      </div>
      <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:16px; align-items:center; margin-top:4px">
        <div class="muted" id="precoMaisBaratoResumo">R$ -</div>
        <a class="buy" href="{{ selecionar_assento_url }}?segmento=volta{% if default_destino %}&origem={{ default_destino|urlencode }}{% endif %}{% if default_origem %}&destino={{ default_origem|urlencode }}{% endif %}{% if default_volta %}&data={{ default_volta|urlencode }}{% endif %}{% if default_pax %}&pax={{ default_pax|urlencode }}{% endif %}" data-segment="volta" data-codigo="FT231">Comprar</a>
      </div>
    </article>

      <section id="dynamicResults" class="results-grid" aria-live="polite"></section>

  </main>
</div>

<script>
  // ---------- utils ----------
  const url = new URLSearchParams(location.search);
  const getQS = (k, def="") => url.get(k) ?? def;

  function fmtDataISO(iso){
    if(!iso) return "‚Äî";
    const d = new Date(iso + "T12:00:00");
    return d.toLocaleDateString("pt-BR", {
      weekday:"short", day:"2-digit", month:"short", year:"numeric"
    }).replace(/\.$/,"");
  }
  function guessIATA(txt){
    txt = (txt||"").toLowerCase();
    // Normalize accents and collapse punctuation
    if (txt.normalize) {
      txt = txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    txt = txt.replace(/[\W_]+/g, ' ').trim();
    // Common typo fixes (ex.: 'S√£op Paulo' -> 'Sao Paulo')
    txt = txt.replace(/\bsaop\b/g, 'sao');
    txt = txt.replace(/\bsaopaulo\b/g, 'sao paulo');

    // Direct IATA detection (if user entered the code)
    const direct = txt.match(/\b([a-zA-Z]{3})\b/);
    if (direct && direct[1]) return direct[1].toUpperCase();

    // No automatic mapping from city name -> IATA any more.
    // Direct IATA detection above will still return a 3-letter code if the user typed it.

    return 'XXX';
  }
  // Return a short city abbreviation (e.g. SP, RJ, NY) for display
  function guessAbbrev(txt){
    txt = (txt||"").toLowerCase();
    if (txt.normalize) {
      txt = txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    txt = txt.replace(/[\W_]+/g, ' ').trim();
    txt = txt.replace(/\bsaop\b/g, 'sao');
    txt = txt.replace(/\bsaopaulo\b/g, 'sao paulo');
    // direct IATA -> abbr (e.g. GRU => SP)
    const direct = txt.match(/\b([a-zA-Z]{3})\b/);
    const iata = (direct && direct[1]) ? direct[1].toUpperCase() : null;
    const iataToAbbr = { 'GRU':'SP','CGH':'SP','GIG':'RJ','EWR':'NYC','JFK':'NYC','BSB':'DF','CNF':'BH','BEL':'BEL','CWB':'CWB','FOR':'FOR','REC':'REC','SSA':'SSA','FLN':'FLN','POA':'POA','MAO':'MAO' };
    if (iata && iataToAbbr[iata]) return iataToAbbr[iata];
    const iata = (direct && direct[1]) ? direct[1].toUpperCase() : null;
    const iataToAbbr = { 'GRU':'SP','CGH':'SP','GIG':'RJ','EWR':'NYC','JFK':'NYC','BSB':'DF','CNF':'BH','BEL':'BEL','CWB':'CWB','FOR':'FOR','REC':'REC','SSA':'SSA','FLN':'FLN','POA':'POA','MAO':'MAO' };
    if (iata && iataToAbbr[iata]) return iataToAbbr[iata];

    const abbrMap = {
      'sao paulo': 'SP', 'guarulhos': 'SP', 'congonhas': 'SP', 'sp': 'SP',
      'rio de janeiro': 'RJ', 'rio': 'RJ', 'galeao': 'RJ', 'rj': 'RJ',
      'belo horizonte': 'BH', 'belem': 'BEL', 'brasilia': 'DF', 'recife': 'REC', 'salvador': 'SSA',
      'fortaleza': 'FOR', 'curitiba': 'CWB', 'florianopolis': 'FLN', 'porto alegre': 'POA', 'manaus': 'MAO',
      'new york': 'NY', 'novaiorque': 'NY', 'londres': 'LON', 'london': 'LON'
    };
    for (const k in abbrMap){
      if (txt.includes(k)) return abbrMap[k];
    }
    // fallback: try to make an abbreviation from city words (first letters)
    const parts = txt.split(/\s+/).filter(Boolean);
    if (parts.length === 1 && parts[0].length <= 3) return parts[0].toUpperCase();
    if (parts.length >= 2){
      const ab = parts.map(p=>p[0]).slice(0,2).join('').toUpperCase();
      return ab;
    }
    return '‚Äî';
  }
  const todayISO = (()=>{ const d=new Date(), p=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; })();

  // ---------- estado vindo da p√°gina anterior ----------
  let origem   = getQS("origem","S√£o Paulo, SP - BR");
  let destino  = getQS("destino","New York, NY - USA");
  let idaISO   = getQS("data","");      // ida
  let voltaISO = getQS("volta","");     // volta (se houver)
  let modo     = getQS("modo","rt");    // 'rt' ida e volta | 'ow' s√≥ ida

  // ---------- refs DOM ----------
  const origemTxt = document.getElementById("origemTxt");
  const destinoTxt= document.getElementById("destinoTxt");
  const boxIda    = document.getElementById("boxIda");
  const boxVolta  = document.getElementById("boxVolta");
  const inpIda    = document.getElementById("inpIda");
  const inpVolta  = document.getElementById("inpVolta");
  const idaTxt    = document.getElementById("idaTxt");
  const voltaTxt  = document.getElementById("voltaTxt");
  const titulos   = document.getElementById("titulos");
  const cardVolta = document.getElementById("cardVolta");
  const btnRT     = document.getElementById("btnRT");
  const btnOW     = document.getElementById("btnOW");
  const apiStatusEl = document.getElementById("apiStatus");
  const precoRecomendadoEl = document.getElementById("precoRecomendado");
  const precoMaisBaratoEl = document.getElementById("precoMaisBarato");
  const precoMaisBaratoResumoEl = document.getElementById("precoMaisBaratoResumo");
  const dynamicResultsEl = document.getElementById("dynamicResults");

  // ---------- preenche painel ----------
  origemTxt.textContent  = origem;
  destinoTxt.textContent = destino;
  inpIda.min = todayISO;
  inpVolta.min = todayISO;

  if (idaISO){ inpIda.value = idaISO; idaTxt.textContent = fmtDataISO(idaISO); inpVolta.min = idaISO; }
  if (voltaISO){ inpVolta.value = voltaISO; voltaTxt.textContent = fmtDataISO(voltaISO); }

  // ---------- cards ----------
  function atualizaCards(){
    const oCity = cidadeSemPais(origem).split(",")[0] || "‚Äî";
    const dCity = cidadeSemPais(destino).split(",")[0] || "‚Äî";
    const oIATA = guessIATA(origem);
    const dIATA = guessIATA(destino);
    const oAbbr = guessAbbrev(origem);
    const dAbbr = guessAbbrev(destino);

    document.getElementById("idaSub").textContent       = idaISO ? fmtDataISO(idaISO) : "‚Äî";
    document.getElementById("origemCode").textContent   = oAbbr || oIATA;
    document.getElementById("origemCity").textContent   = oCity;
    document.getElementById("destinoCode").textContent  = dAbbr || dIATA;
    document.getElementById("destinoCity").textContent  = dCity;

    // For the return card (VOLTA), display the *reverse* direction: destino -> origem
    document.getElementById("voltaSub").textContent     = voltaISO ? fmtDataISO(voltaISO) : "‚Äî";
    // origin on the return card should be the original 'destino'
    document.getElementById("origemCode2").textContent  = dAbbr || dIATA;
    document.getElementById("origemCity2").textContent  = dCity;
    // destination on the return card should be the original 'origem'
    document.getElementById("destinoCode2").textContent = oAbbr || oIATA;
    document.getElementById("destinoCity2").textContent = oCity;
  }
  atualizaCards();

  // ---------- abrir datepicker ----------
  function guessIATA(txt){
    txt = (txt||"").toLowerCase();
    // Normalize accents and collapse punctuation
    if (txt.normalize) {
      txt = txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    txt = txt.replace(/[\W_]+/g, ' ').trim();
    // Common typo fixes (ex.: 'S√£op Paulo' -> 'Sao Paulo')
    txt = txt.replace(/\bsaop\b/g, 'sao');
    txt = txt.replace(/\bsaopaulo\b/g, 'sao paulo');

    // Direct IATA detection (if user entered the code)
    const direct = txt.match(/\b([a-zA-Z]{3})\b/);
    if (direct && direct[1]) return direct[1].toUpperCase();

    // No automatic mapping from city name -> IATA any more.
    // Direct IATA detection above will still return a 3-letter code if the user typed it.

    return 'XXX';
  }
  // Return a short city abbreviation (e.g. SP, RJ, NY) for display
  function guessAbbrev(txt){
    txt = (txt||"").toLowerCase();
    if (txt.normalize) {
      txt = txt.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    txt = txt.replace(/[\W_]+/g, ' ').trim();
    txt = txt.replace(/\bsaop\b/g, 'sao');
    txt = txt.replace(/\bsaopaulo\b/g, 'sao paulo');
    // direct IATA -> abbr (e.g. GRU => SP)
    const direct = txt.match(/\b([a-zA-Z]{3})\b/);
    const iata = (direct && direct[1]) ? direct[1].toUpperCase() : null;
    const iataToAbbr = { 'GRU':'SP','CGH':'SP','GIG':'RJ','EWR':'NYC','JFK':'NYC','BSB':'DF','CNF':'BH','BEL':'BEL','CWB':'CWB','FOR':'FOR','REC':'REC','SSA':'SSA','FLN':'FLN','POA':'POA','MAO':'MAO' };
    if (iata && iataToAbbr[iata]) return iataToAbbr[iata];

    const abbrMap = {
      'sao paulo': 'SP', 'guarulhos': 'SP', 'congonhas': 'SP', 'sp': 'SP',
      'rio de janeiro': 'RJ', 'rio': 'RJ', 'galeao': 'RJ', 'rj': 'RJ',
      'belo horizonte': 'BH', 'belem': 'BEL', 'brasilia': 'DF', 'recife': 'REC', 'salvador': 'SSA',
      'fortaleza': 'FOR', 'curitiba': 'CWB', 'florianopolis': 'FLN', 'porto alegre': 'POA', 'manaus': 'MAO',
      'new york': 'NY', 'novaiorque': 'NY', 'londres': 'LON', 'london': 'LON'
    };
    for (const k in abbrMap){
      if (txt.includes(k)) return abbrMap[k];
    }
    // fallback: try to make an abbreviation from city words (first letters)
    const parts = txt.split(/\s+/).filter(Boolean);
    if (parts.length === 1 && parts[0].length <= 3) return parts[0].toUpperCase();
    if (parts.length >= 2){
      const ab = parts.map(p=>p[0]).slice(0,2).join('').toUpperCase();
      return ab;
    }
    return '‚Äî';
    const dataSegment = opts.data || (segmento === 'volta' ? (voltaISO || idaISO || '') : (idaISO || ''));
    if (dataSegment) params.set('data', dataSegment);
    if (opts.tarifa) params.set('tarifa', opts.tarifa);
    params.set('pax', String(getTotalPax()));
    // For return flights, swap origem and destino so the seat page opens for the right leg.
    if (segmento === 'volta'){
      const o = params.get('origem');
      const d = params.get('destino');
      params.set('origem', d || '');
      params.set('destino', o || '');
    }
    window.location.href = `/resultados/assentos/?${params.toString()}`;
  }

  function renderFlightOptions(payload){
    if (!dynamicResultsEl || !payload) {
      if (dynamicResultsEl) dynamicResultsEl.innerHTML = '';
      return;
    }
    const origemDesc = cidadeSemPais(payload.parametros?.origem || origem).split(',')[0] || 'Origem';
    const destinoDesc = cidadeSemPais(payload.parametros?.destino || destino).split(',')[0] || 'Destino';
    const rec = payload.recomendado || {};
    const barato = payload.mais_barato || {};
    const premiumPrice = rec.preco ? `R$ ${(rec.preco * 1.18).toFixed(0)}` : 'R$ -';
    const swiftPrice = rec.preco ? `R$ ${(rec.preco * 1.08).toFixed(0)}` : 'R$ -';

    const options = [
      {
        label: 'Tarifa Recomendada', airline: 'LATAM', code: 'FT230', segmento: 'ida',
        horario: '22h15 ‚Üí 07h20', detalhe: `${origemDesc} ‚Üí ${destinoDesc} ¬∑ Direto`,
        price: rec.preco_fmt || 'R$ -', badge: rec.descricao || 'Inclui 1 mala despachada', data: idaISO,
        origem: origemDesc, destino: destinoDesc,
      },
      {
        label: 'Mais Barata', airline: 'GOL', code: 'FT450', segmento: 'ida',
        horario: '06h40 ‚Üí 12h55', detalhe: '1 parada ¬∑ Assento econ√¥mico',
        price: barato.preco_fmt || 'R$ -', badge: barato.descricao || 'Tarifa Light', data: idaISO,
        origem: origemDesc, destino: destinoDesc,
      },
      {
        label: 'Executiva Flex', airline: 'Delta', code: 'DT980', segmento: 'ida',
        horario: '20h05 ‚Üí 05h10', detalhe: 'Direto ¬∑ Lounge & refei√ß√£o',
        price: premiumPrice, badge: 'Upgrade autom√°tico de assento', data: idaISO,
        origem: origemDesc, destino: destinoDesc,
      },
      {
        label: 'Mais R√°pida', airline: 'United', code: 'UA522', segmento: 'ida',
        horario: '09h30 ‚Üí 15h20', detalhe: 'Direto ¬∑ Prioridade de embarque',
        price: swiftPrice, badge: 'Sele√ß√£o gr√°tis de assentos', data: idaISO,
        origem: origemDesc, destino: destinoDesc,
      },
    ];

    dynamicResultsEl.innerHTML = options.map(opt => `
      <article class="result-card">
        <header>
          <div>${opt.label}</div>
          <div class="airline">${opt.airline} ‚Ä¢ ${opt.code}</div>
        </header>
        <div class="schedule">${opt.horario}</div>
        <div class="supplement">${opt.detalhe}</div>
        <div class="supplement">${opt.badge}</div>
        <footer>
          <div class="price">${opt.price}</div>
          <button type="button" class="btn-select" data-option="${opt.label}" data-segment="${opt.segmento}" data-tarifa="${opt.price}" data-codigo="${opt.code}" data-origem="${opt.origem}" data-destino="${opt.destino}" data-data="${opt.data || ''}">Selecionar</button>
        </footer>
      </article>
    `).join('');
  }

  async function consultarTarifas(){
    if (!apiStatusEl) return;
    apiStatusEl.textContent = 'Consultando tarifas em tempo real‚Ä¶';
    apiStatusEl.classList.remove('is-error','is-ok');
    const params = new URLSearchParams({
      origem,
      destino,
      pax: String(getTotalPax()),
    });
    if (idaISO) params.set('data', idaISO);

    try {
      const response = await fetch(`/api/voos/?${params.toString()}`, {
        headers: { 'Accept': 'application/json' },
        credentials: 'same-origin',
      });

      if (response.status === 403) {
        throw new Error('Fa√ßa login para consultar tarifas personalizadas.');
      }
      if (!response.ok) {
        throw new Error(`Erro ao consultar a API (HTTP ${response.status}).`);
      }

      const payload = await response.json();
      const recomendado = payload.recomendado || {};
      const barato = payload.mais_barato || {};

      if (precoRecomendadoEl) precoRecomendadoEl.textContent = recomendado.preco_fmt || 'R$ -';
      if (precoMaisBaratoEl) precoMaisBaratoEl.textContent = barato.preco_fmt || 'R$ -';
      if (precoMaisBaratoResumoEl) {
        const descricao = barato.descricao ? ` ¬∑ ${barato.descricao}` : '';
        precoMaisBaratoResumoEl.textContent = (barato.preco_fmt || 'R$ -') + descricao;
      }

      const origemDesc = payload.parametros?.origem || origem || 'origem';
      const destinoDesc = payload.parametros?.destino || destino || 'destino';
      apiStatusEl.textContent = `Tarifas calculadas para ${origemDesc} ‚Üí ${destinoDesc}.`;
      apiStatusEl.classList.add('is-ok');
      renderFlightOptions(payload);
    } catch (err) {
      if (precoRecomendadoEl) precoRecomendadoEl.textContent = 'R$ -';
      if (precoMaisBaratoEl) precoMaisBaratoEl.textContent = 'R$ -';
      if (precoMaisBaratoResumoEl) precoMaisBaratoResumoEl.textContent = 'R$ -';
      const msg = err.message || 'N√£o foi poss√≠vel consultar a API.';
      if (err.message && err.message.includes('Fa√ßa login')){
        apiStatusEl.innerHTML = `${msg} <a href="/login/" style="color:#0a58ca">Entrar</a>`;
      } else {
        apiStatusEl.textContent = msg;
      }
      apiStatusEl.classList.add('is-error');
      renderFlightOptions(null);
    }
  }

  // ---------- intera√ß√µes ----------
  // p√≠lulas como bot√µes
  boxIda.addEventListener("click",  ()=> openPicker(inpIda));
  boxVolta.addEventListener("click",()=> { if(modo==='rt') openPicker(inpVolta); });

  boxIda.addEventListener("keydown",  e=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); openPicker(inpIda);} });
  boxVolta.addEventListener("keydown",e=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); if(modo==='rt') openPicker(inpVolta);} });

  // escolher datas
  inpIda.addEventListener("change", ()=>{
    idaISO = inpIda.value || "";
    idaTxt.textContent = fmtDataISO(idaISO);
    inpVolta.min = idaISO || todayISO;
    if (voltaISO && voltaISO < idaISO){
      voltaISO = ""; inpVolta.value = ""; voltaTxt.textContent = "‚Äî";
    }
    handleStateChange();
  });
  inpVolta.addEventListener("change", ()=>{
    voltaISO = inpVolta.value || "";
    voltaTxt.textContent = fmtDataISO(voltaISO);
    handleStateChange();
  });

  // inverter origem/destino
  document.getElementById("swapBtn").addEventListener("click", ()=>{
    [origem, destino] = [destino, origem];
    origemTxt.textContent = origem;
    destinoTxt.textContent = destino;
    handleStateChange();
  });

  // bot√£o "Buscar" ‚Äî volta para a p√°gina anterior levando o estado
  document.getElementById("refazerBusca").addEventListener("click", ()=>{
    const params = new URLSearchParams({
      origem, destino, data: idaISO || "", volta: (modo==='rt' ? (voltaISO||"") : "")
    }).toString();
    const paxParam = getTotalPax();
    const finalParams = new URLSearchParams(params);
    if (paxParam > 1) finalParams.set('pax', paxParam);
    window.location.href = "/?" + finalParams.toString();
  });

  // ---------- MODO: S√≥ ida / Ida e Volta ----------
  function setTripMode(newMode){
    modo = newMode;
    btnRT.classList.toggle('is-active', modo==='rt');
    btnOW.classList.toggle('is-active', modo==='ow');

    if (modo === 'ow'){
      // desativa/oculta volta
      cardVolta.style.display = 'none';
      boxVolta.classList.add('is-disabled');
      inpVolta.disabled = true;
      // limpa volta
      voltaISO = '';
      inpVolta.value = '';
      voltaTxt.textContent = '‚Äî';
      titulos.textContent = 'Voos s√≥ ida';
    } else {
      // reativa volta
      cardVolta.style.display = '';
      boxVolta.classList.remove('is-disabled');
      inpVolta.disabled = false;
      titulos.textContent = 'Voos ida e volta';
    }
    handleStateChange();
  }

  // cliques dos bot√µes
  btnOW.addEventListener('click', ()=> setTripMode('ow'));
  btnRT.addEventListener('click', ()=> setTripMode('rt'));

  // --------- Passageiros & Classe ----------
  const paxField   = document.getElementById('paxField');
  const paxPop     = document.getElementById('paxPop');
  const paxSummary = document.getElementById('paxSummary');

  // estado
  const pax = { adultos: 1, idosos: 0, criancas: 0 };
  let cabin = 'Econ√¥mica';

  const qsPaxTotal = parseInt(getQS('pax', '1'), 10);
  if (Number.isFinite(qsPaxTotal) && qsPaxTotal > 1){
    pax.adultos = Math.min(qsPaxTotal, 9);
    const adNumEl = document.getElementById('adNum');
    if (adNumEl) adNumEl.textContent = pax.adultos;
  }

  function getTotalPax(){
    return Math.max(pax.adultos + pax.idosos + pax.criancas, 1);
  }

  function plural(n, s, p){ return n===1 ? s : p; }
  function renderSummary(){
    const total = pax.adultos + pax.idosos + pax.criancas;
    const g = total === 1 ? 'pessoa' : 'pessoas';
    paxSummary.textContent = `${total} ${g} ¬∑ ${cabin}`;
  }
  renderSummary();

  // abre/fecha
  function togglePax(open){
    const isOpen = (open===undefined) ? paxPop.classList.contains('is-open') : !open;
    if (isOpen){ paxPop.classList.remove('is-open'); paxField.setAttribute('aria-expanded','false'); }
    else { paxPop.classList.add('is-open'); paxField.setAttribute('aria-expanded','true'); }
  }
  paxField.addEventListener('click', ()=> togglePax(true));
  paxField.addEventListener('keydown', e=>{
    if (e.key==='Enter' || e.key===' ') { e.preventDefault(); togglePax(true); }
  });

  // fechar ao clicar fora / Esc
  document.addEventListener('click', (e)=>{
    if (!paxPop.contains(e.target) && !paxField.contains(e.target)) {
      paxPop.classList.remove('is-open'); paxField.setAttribute('aria-expanded','false');
    }
  });
  document.addEventListener('keydown', (e)=>{
    if (e.key==='Escape') { paxPop.classList.remove('is-open'); paxField.setAttribute('aria-expanded','false'); }
  });

  // steppers
  function bindStepper(minusId, plusId, key){
    const minus = document.getElementById(minusId);
    const plus  = document.getElementById(plusId);
    const numEl = document.getElementById(key==='adultos'?'adNum': key==='idosos'?'idNum':'chNum');

    minus.addEventListener('click', ()=>{
      pax[key] = Math.max(0, pax[key]-1);
      numEl.textContent = pax[key];
    });
    plus.addEventListener('click', ()=>{
      pax[key] = Math.min(9, pax[key]+1);
      numEl.textContent = pax[key];
    });
  }
  bindStepper('adMenos','adMais','adultos');
  bindStepper('idMenos','idMais','idosos');
  bindStepper('chMenos','chMais','criancas');

  // cabine
  document.querySelectorAll('input[name="cabin"]').forEach(r=>{
    r.addEventListener('change', ()=> { cabin = r.value; });
  });

  // aplicar/cancelar
  document.getElementById('paxApply').addEventListener('click', ()=>{
    // garante pelo menos 1 passageiro
    if (pax.adultos + pax.idosos + pax.criancas === 0) { pax.adultos = 1; document.getElementById('adNum').textContent = 1; }
    renderSummary();
    paxPop.classList.remove('is-open');
    paxField.setAttribute('aria-expanded','false');
    handleStateChange();

    // (opcional) salvar na URL junto com o resto do estado:
    // if (typeof history !== 'undefined') {
    //   const p = new URLSearchParams(location.search);
    //   p.set('ad', pax.adultos); p.set('id', pax.idosos); p.set('ch', pax.criancas); p.set('cab', cabin);
    //   history.replaceState(null,'',location.pathname+'?'+p.toString());
    // }
  });
  document.getElementById('paxCancel').addEventListener('click', ()=>{
    paxPop.classList.remove('is-open');
    paxField.setAttribute('aria-expanded','false');
  });

  // aplica modo vindo da URL ao carregar (ap√≥s inicializar pax)
  setTripMode(modo === 'ow' ? 'ow' : 'rt');

  document.querySelectorAll('.btn-seat').forEach(btn=>{
    btn.addEventListener('click', (event)=>{
      event.preventDefault();
      const segmento = btn.dataset.segment || 'ida';
      const tarifa = segmento === 'ida'
        ? (precoRecomendadoEl?.textContent || '')
        : (precoMaisBaratoEl?.textContent || '');
      openSeatSelection({ segmento, tarifa, codigo: btn.dataset.codigo });
    });
  });

  const buyBtn = document.querySelector('.buy');
  buyBtn?.addEventListener('click', (event)=>{
    event.preventDefault();
    openSeatSelection({
      segmento: buyBtn.dataset.segment || 'volta',
      tarifa: precoMaisBaratoEl?.textContent || '',
      codigo: buyBtn.dataset.codigo,
    });
  });

  consultarTarifas();

  if (dynamicResultsEl){
    dynamicResultsEl.addEventListener('click', (event)=>{
      const btn = event.target.closest('.btn-select');
      if (!btn) return;
      openSeatSelection({
        segmento: btn.dataset.segment || 'ida',
        tarifa: btn.dataset.tarifa,
        codigo: btn.dataset.codigo,
        origem: btn.dataset.origem,
        destino: btn.dataset.destino,
        data: btn.dataset.data,
      });
    });
  }



</script>

</body>
</html>
